<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Record Page</title>
  <style>
    :root{
      /* Cleaner, more native SF-ish stack (less rigid) */
      --font: "Salesforce Sans", ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";

      --bg: transparent;
      --card: #ffffff;
      --border: #e6e6e6;
      --muted: #6b7280;
      --text: #111827;

      --blue: #17345b;
      --blue-2: #1d63ff;

      --radius: 12px;

      --padY: 12px;
      --padX: 10px;

      --gap: 12px;

      --field-h: 34px;
      --field-radius: 8px;
      --field-bg: #ffffff;
      --field-border: #d1d5db;

      --toast-bg: #bff3ea;
      --toast-fg: #0d3a33;
      --toast-shadow: 0 10px 30px rgba(0,0,0,0.10);
      --toast-radius: 10px;
    }

    html,body{
      width:100%;
      max-width:100%;
      overflow-x:hidden;
      background: var(--bg);
      font-family: var(--font);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin:0;
      padding:0;
    }

    body{
      padding: var(--padY) var(--padX);
      box-sizing:border-box;
      min-height: 180px;
    }

    .page{
      width:100%;
      max-width: 100%;
      min-width: 0;
      display:flex;
      flex-direction: column;
      gap: var(--gap);
    }

    /* ----- Minimal, clean containers (less “bubbly”) ----- */
    .section{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
    }

    .sectionHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      min-width:0;
    }

    /* Header */
    .headerLeft{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }

    .iconBadge{
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: rgba(29,99,255,0.10);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }

    .recordTitle{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .recordType{
      font-size: 11px;
      font-weight: 650;
      color: var(--muted);
      line-height: 1.2;
    }
    .recordName{
      font-size: 14px;
      font-weight: 750;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }

    .headerActions{
      display:flex;
      align-items:center;
      gap: 8px;
      flex: 0 0 auto;
    }

    .btn{
      height: 32px;
      padding: 0 10px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: #fff;
      color: #111;
      font-size: 12px;
      font-weight: 650;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap: 8px;
      transition: transform 120ms ease, filter 120ms ease;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }

    .btnPrimary{
      border: 0;
      background: var(--blue-2);
      color: #fff;
      font-weight: 700;
    }
    .btnPrimary:hover{ filter: brightness(1.03); }

    /* Highlights row (remove “bubble cards”; keep clean) */
    .highlights{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0;
      padding: 10px 12px;
    }

    .metric{
      padding: 8px 10px;
      min-width:0;
    }
    .metric + .metric{
      border-left: 1px solid var(--border);
    }
    .metricLabel{
      font-size: 11px;
      font-weight: 650;
      color: var(--muted);
    }
    .metricValue{
      margin-top: 6px;
      font-size: 18px;
      font-weight: 750;
      letter-spacing: .1px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    /* Main grid */
    .grid{
      display:grid;
      grid-template-columns: minmax(0, 2fr) minmax(280px, 1fr);
      gap: var(--gap);
      align-items:start;
      min-width:0;
    }

    /* Tabs: NOT bubbles. Clickable categories with underline like SF */
    .tabsBar{
      display:flex;
      align-items:center;
      gap: 18px;
      padding: 10px 12px 0 12px;
      background: #fff;
    }
    .tabLink{
      appearance:none;
      border:0;
      background: transparent;
      padding: 8px 0;
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      cursor:pointer;
      position: relative;
    }
    .tabLink[aria-selected="true"]{
      color: var(--text);
    }
    .tabLink[aria-selected="true"]::after{
      content:"";
      position:absolute;
      left:0;
      right:0;
      bottom:-1px;
      height:2px;
      background: var(--blue-2);
      border-radius: 2px;
    }
    .tabsDivider{
      border-bottom: 1px solid var(--border);
      margin: 0 12px;
    }

    .tabPanel{
      padding: 12px;
      min-width:0;
    }
    .tabPanel[hidden]{ display:none; }

    /* “Details-style” fields (fixed placement, never disappear) */
    .detailsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 0 24px;
      min-width:0;
    }

    .detailsCol{
      display:flex;
      flex-direction:column;
      gap: 0;
      min-width:0;
    }

    .row{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 12px;
      align-items:center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,0.04); /* very subtle */
      min-width:0;
    }
    .row:last-child{ border-bottom: 0; }

    .rowLabel{
      font-size: 11px;
      font-weight: 650;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .input{
      width: 100%;
      height: var(--field-h);
      border-radius: var(--field-radius);
      border: 1px solid var(--field-border);
      background: var(--field-bg);
      padding: 0 10px;
      box-sizing:border-box;
      font-size: 12px;
      font-weight: 600;
      color: #111;
      outline: none;
      transition: box-shadow 140ms ease, border-color 140ms ease;
      min-width:0;
    }
    .input:focus{
      border-color: rgba(29,99,255,0.55);
      box-shadow: 0 0 0 3px rgba(29,99,255,0.10);
    }

    /* subtle placeholder styling */
    .input::placeholder{
      color: rgba(107,114,128,0.9);
      font-weight: 550;
    }

    .rowActions{
      display:flex;
      gap: 8px;
      justify-content:flex-end;
      margin-top: 12px;
    }

    .btnSmall{
      height: 30px;
      padding: 0 10px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 700;
    }

    /* Right panel body */
    .panelBody{
      padding: 12px;
      min-width:0;
    }

    /* Related table (keep clean) */
    .tableWrap{
      width:100%;
      overflow:auto;
    }
    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 760px;
    }
    thead th{
      background: #fafafa;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      font-weight: 700;
      color: #374151;
      text-align:left;
      padding: 10px 10px;
      position: sticky;
      top: 0;
      z-index: 1;
      white-space: nowrap;
    }
    tbody td{
      border-bottom: 1px solid rgba(0,0,0,0.06);
      padding: 10px 10px;
      font-size: 12px;
      font-weight: 600;
      color: #111827;
      vertical-align: middle;
      white-space: nowrap;
    }

    .nameCell{
      font-weight: 700;
      max-width: 240px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .muted{
      color: var(--muted);
      font-weight: 600;
    }

    /* Toast */
    .toast{
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%) translateY(-10px);
      opacity: 0;
      pointer-events:none;
      background: var(--toast-bg);
      color: var(--toast-fg);
      border-radius: var(--toast-radius);
      box-shadow: var(--toast-shadow);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 320px;
      max-width: min(520px, calc(100vw - 24px));
      z-index: 99999;
      transition: opacity 200ms ease, transform 200ms ease;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(0px);
      pointer-events:auto;
    }
    .toast .msg{
      font-weight: 700;
      font-size: 13px;
      flex:1;
    }
    .toast .x{
      border:0;
      background: transparent;
      cursor:pointer;
      width: 26px;
      height: 26px;
      display:grid;
      place-items:center;
      border-radius: 7px;
      transition: background 120ms ease;
    }
    .toast .x:hover{ background: rgba(0,0,0,0.06); }

    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
      table{ min-width: 720px; }
      .highlights{ grid-template-columns: 1fr; }
      .metric + .metric{ border-left: 0; border-top: 1px solid var(--border); }
      .detailsGrid{ grid-template-columns: 1fr; }
      .row{ grid-template-columns: 140px 1fr; }
    }
  </style>
</head>

<body>
  <div class="page" id="app">

    <!-- Header -->
    <div class="section">
      <div class="sectionHeader">
        <div class="headerLeft">
          <div class="iconBadge" aria-hidden="true">
            <svg width="16" height="16" viewBox="0 0 24 24">
              <path fill="#1d63ff" d="M12 12c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4Zm0 2c-2.7 0-8 1.4-8 4v2h16v-2c0-2.6-5.3-4-8-4Z"/>
            </svg>
          </div>
          <div class="recordTitle">
            <div class="recordType">Lead</div>
            <div class="recordName" id="recordName">—</div>
          </div>
        </div>

        <div class="headerActions">
          <button class="btn" id="refreshBtn" type="button" title="Refresh data">
            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="#111827" d="M17.65 6.35A7.95 7.95 0 0 0 12 4V1L7 6l5 5V7a6 6 0 1 1-6 6H4a8 8 0 1 0 13.65-6.65Z"/>
            </svg>
            Refresh
          </button>
          <button class="btn btnPrimary" id="saveAllBtn" type="button" title="Save all changes">
            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="#fff" d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4Zm0 16H7v-6h10v6Zm-3-10H6V5h8v4Z"/>
            </svg>
            Save Changes
          </button>
        </div>
      </div>

      <div class="highlights">
        <div class="metric">
          <div class="metricLabel">Lead Score</div>
          <div class="metricValue" id="metricLeadScore">—</div>
        </div>
        <div class="metric">
          <div class="metricLabel">Age in Stage</div>
          <div class="metricValue" id="metricAgeInStage">—</div>
        </div>
        <div class="metric">
          <div class="metricLabel">Days Since Last Activity</div>
          <div class="metricValue" id="metricDaysSince">—</div>
        </div>
      </div>
    </div>

    <!-- Main -->
    <div class="grid">

      <!-- Left: tabs + details layout -->
      <div class="section">
        <div class="tabsBar" role="tablist" aria-label="Record tabs">
          <button class="tabLink" id="tabDeal" role="tab" aria-selected="true" aria-controls="panelDeal" type="button">Deal Information</button>
          <button class="tabLink" id="tabResearch" role="tab" aria-selected="false" aria-controls="panelResearch" type="button">Deep Research</button>
        </div>
        <div class="tabsDivider"></div>

        <div class="tabPanel" id="panelDeal" role="tabpanel" aria-labelledby="tabDeal">
          <div class="detailsGrid">
            <div class="detailsCol" id="dealColLeft"></div>
            <div class="detailsCol" id="dealColRight"></div>
          </div>
          <div class="rowActions">
            <button class="btn btnSmall" id="saveDealBtn" type="button">Save Deal Info</button>
          </div>
        </div>

        <div class="tabPanel" id="panelResearch" role="tabpanel" aria-labelledby="tabResearch" hidden>
          <div class="detailsGrid">
            <div class="detailsCol" id="researchColLeft"></div>
            <div class="detailsCol" id="researchColRight"></div>
          </div>
          <div class="rowActions">
            <button class="btn btnSmall" id="saveResearchBtn" type="button">Save Deep Research</button>
          </div>
        </div>
      </div>

      <!-- Right: Action panel -->
      <div class="section">
        <div class="sectionHeader">
          <div style="min-width:0;">
            <div style="font-size:12px;font-weight:750;">Next Actions</div>
            <div style="font-size:11px;font-weight:600;color:var(--muted);">Follow-up + next step</div>
          </div>
        </div>
        <div class="panelBody" id="actionPanel"></div>
        <div class="rowActions" style="padding: 0 12px 12px;">
          <button class="btn btnSmall btnPrimary" id="saveActionsBtn" type="button">Save Actions</button>
        </div>
      </div>

    </div>

    <!-- Related records -->
    <div class="section">
      <div class="sectionHeader">
        <div style="min-width:0;">
          <div style="font-size:12px;font-weight:750;">Related Records</div>
          <div style="font-size:11px;font-weight:600;color:var(--muted);">Owners / Subitems</div>
        </div>
        <button class="btn" id="saveSubitemsBtn" type="button">Save Subitems</button>
      </div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Offer Made</th>
              <th>Relationship</th>
              <th>Lead Status</th>
              <th>Phone 1</th>
              <th>Phone 1 Status</th>
              <th>Phone 2</th>
              <th>Phone 2 Status</th>
              <th>Phone 3</th>
              <th>Phone 3 Status</th>
            </tr>
          </thead>
          <tbody id="subitemsBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite">
    <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
      <path fill="#0ba79c" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm-1 14-4-4 1.4-1.4L11 12.2l5.6-5.6L18 8l-7 8Z"/>
    </svg>
    <div class="msg" id="toastMsg">Saved.</div>
    <button class="x" id="toastClose" type="button" aria-label="Dismiss">
      <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#0d3a33" d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3z"/>
      </svg>
    </button>
  </div>

  <script>
    // OPTIONAL (later): Paste your Make webhook endpoints (FULL URLs)
    // If you haven't set these yet, the UI will STILL render with empty fields (this update).
    const MAKE_GET_RECORD_URL = ""; // ex: "https://hook.us1.make.com/xxxxxxx"
    const MAKE_SET_FIELD_URL  = ""; // ex: "https://hook.us1.make.com/yyyyyyy"

    // Titles to match from your board (for real data later)
    const TITLES = {
      leadScore: "Lead Score",
      ageInStage: "Age In Stage",
      lastActivityDate: "Last Activity Date",

      address: "Address",
      city: "City",
      leadType: "Lead Type",
      taxes: "Taxes",
      condition: "Condition",
      occupancy: "Occupancy",
      titleIssue: "Title issue",
      willStatus: "Will Status",
      deedStatus: "Deed Status",

      taxAssessor: "Tax Assesor",
      zillow: "Zillow",
      obituary: "Obituary",
      ancestry: "Ancestry",
      age: "Age",
      birthDate: "Birth Date",
      deathDate: "Death Date",

      followUpDate: "Follow Up Date",
      nextActionStep: "Next Action Step",
      stalledReason: "Stalled Reason"
    };

    const SUB_TITLES = {
      offerMade: "Offer Made",
      relationship: "Relation Ship",
      leadStatus: "Lead Status",
      phone1: "Phone 1",
      phone1Status: "Phone 1 status",
      phone2: "Phone 2",
      phone2Status: "Phone 2 status",
      phone3: "Phone 3",
      phone3Status: "Phone 3 status"
    };

    // --- DOM
    const recordNameEl = document.getElementById("recordName");
    const metricLeadScoreEl = document.getElementById("metricLeadScore");
    const metricAgeInStageEl = document.getElementById("metricAgeInStage");
    const metricDaysSinceEl = document.getElementById("metricDaysSince");

    const dealColLeft = document.getElementById("dealColLeft");
    const dealColRight = document.getElementById("dealColRight");
    const researchColLeft = document.getElementById("researchColLeft");
    const researchColRight = document.getElementById("researchColRight");

    const actionPanelEl = document.getElementById("actionPanel");
    const subitemsBodyEl = document.getElementById("subitemsBody");

    const refreshBtn = document.getElementById("refreshBtn");
    const saveAllBtn = document.getElementById("saveAllBtn");
    const saveDealBtn = document.getElementById("saveDealBtn");
    const saveResearchBtn = document.getElementById("saveResearchBtn");
    const saveActionsBtn = document.getElementById("saveActionsBtn");
    const saveSubitemsBtn = document.getElementById("saveSubitemsBtn");

    // Tabs
    const tabDeal = document.getElementById("tabDeal");
    const tabResearch = document.getElementById("tabResearch");
    const panelDeal = document.getElementById("panelDeal");
    const panelResearch = document.getElementById("panelResearch");

    // Toast
    const toast = document.getElementById("toast");
    const toastMsg = document.getElementById("toastMsg");
    const toastClose = document.getElementById("toastClose");
    let toastTimer = null;

    function showToast(msg){
      toastMsg.textContent = msg || "Saved.";
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toast.classList.remove("show"), 2400);
    }
    toastClose.addEventListener("click", ()=>toast.classList.remove("show"));

    function getParam(name){
      return new URLSearchParams(window.location.search).get(name);
    }

    // --- State
    let record = null;
    let itemColsByTitle = new Map();
    const dirty = {
      item: new Map(),        // columnId -> payload
      subitems: new Map()     // `${subitemId}:${columnId}` -> payload
    };

    function normalize(s){ return String(s || "").trim().toLowerCase(); }

    function indexColumns(columnValues){
      const byTitle = new Map();
      (columnValues || []).forEach(cv => byTitle.set(normalize(cv.title), cv));
      return byTitle;
    }

    function findByTitle(byTitleMap, title){
      if(!title) return null;
      const exact = byTitleMap.get(normalize(title));
      if(exact) return exact;
      const t = normalize(title);
      for(const [k,v] of byTitleMap.entries()){
        if(k.includes(t) || t.includes(k)) return v;
      }
      return null;
    }

    function parseDateFromText(text){
      const s = String(text || "").trim();
      if(!s) return null;
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }

    function toISODate(text){
      const d = parseDateFromText(text);
      if(!d) return "";
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function daysBetween(d1, d2){
      const a = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate()).getTime();
      const b = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate()).getTime();
      return Math.floor((b - a) / (1000*60*60*24));
    }

    /**
     * ✅ KEY CHANGE:
     * We ALWAYS create/render the rows (even if there's no data and no columns yet).
     * - If we don't have columnId yet, input still appears and is editable.
     * - It just won't "save" until Make + Monday mapping exists (expected).
     */
    function makeRow({label, valueText, kind="text", columnId=null, valueType="text", placeholder=""}){
      const row = document.createElement("div");
      row.className = "row";

      const l = document.createElement("div");
      l.className = "rowLabel";
      l.textContent = label;

      const input = document.createElement("input");
      input.className = "input";
      input.type = (kind === "date") ? "date" : "text";
      input.placeholder = placeholder || "";
      input.value = (kind === "date") ? toISODate(valueText) : (valueText || "");

      input.addEventListener("change", ()=>{
        if(!columnId) return; // cannot save until real Monday columns exist / loaded
        dirty.item.set(columnId, {
          target:"item",
          itemId: record?.id,
          columnId,
          valueText: input.value,
          valueType: valueType || (kind === "date" ? "date" : "text")
        });
      });

      row.appendChild(l);
      row.appendChild(input);
      return row;
    }

    function buildMetrics(){
      const byTitle = itemColsByTitle;
      metricLeadScoreEl.textContent = findByTitle(byTitle, TITLES.leadScore)?.text || "—";
      metricAgeInStageEl.textContent = findByTitle(byTitle, TITLES.ageInStage)?.text || "—";

      const lastAct = findByTitle(byTitle, TITLES.lastActivityDate);
      const d = parseDateFromText(lastAct?.text || "");
      metricDaysSinceEl.textContent = d ? `${Math.max(0, daysBetween(d, new Date()))} days` : "—";
    }

    // Fixed layout field lists (these rows ALWAYS render)
    const DEAL_LEFT = [
      { key:"address", label:"Address", placeholder:"Enter address" },
      { key:"city", label:"City", placeholder:"Enter city" },
      { key:"leadType", label:"Lead Type", placeholder:"Enter lead type" },
      { key:"taxes", label:"Taxes", placeholder:"Enter taxes info" }
    ];
    const DEAL_RIGHT = [
      { key:"condition", label:"Condition", placeholder:"Enter condition" },
      { key:"occupancy", label:"Occupancy", placeholder:"Enter occupancy" },
      { key:"titleIssue", label:"Title issue", placeholder:"Enter title issue" },
      { key:"willStatus", label:"Will Status", placeholder:"Enter will status" },
      { key:"deedStatus", label:"Deed Status", placeholder:"Enter deed status" }
    ];

    const RESEARCH_LEFT = [
      { key:"taxAssessor", label:"Tax Assessor Link", placeholder:"Paste link" },
      { key:"zillow", label:"Zillow", placeholder:"Paste link" },
      { key:"obituary", label:"Obituary", placeholder:"Paste link" },
      { key:"ancestry", label:"Ancestry", placeholder:"Paste link" }
    ];
    const RESEARCH_RIGHT = [
      { key:"age", label:"Age", placeholder:"Enter age" },
      { key:"birthDate", label:"Birth Date", kind:"date" },
      { key:"deathDate", label:"Death Date", kind:"date" }
    ];

    const ACTIONS = [
      { key:"followUpDate", label:"Follow Up Date", kind:"date" },
      { key:"nextActionStep", label:"Next Action Step", placeholder:"Enter next step" },
      { key:"stalledReason", label:"Stalled Reason", placeholder:"Enter stalled reason" }
    ];

    function buildDealInfo(){
      dealColLeft.innerHTML = "";
      dealColRight.innerHTML = "";
      const byTitle = itemColsByTitle;

      DEAL_LEFT.forEach(f=>{
        const cv = findByTitle(byTitle, TITLES[f.key]);
        dealColLeft.appendChild(makeRow({
          label: f.label,
          valueText: cv?.text || "",
          kind: f.kind || (cv?.type === "date" ? "date" : "text"),
          columnId: cv?.id || null,
          valueType: cv?.type || "text",
          placeholder: f.placeholder || ""
        }));
      });

      DEAL_RIGHT.forEach(f=>{
        const cv = findByTitle(byTitle, TITLES[f.key]);
        dealColRight.appendChild(makeRow({
          label: f.label,
          valueText: cv?.text || "",
          kind: f.kind || (cv?.type === "date" ? "date" : "text"),
          columnId: cv?.id || null,
          valueType: cv?.type || "text",
          placeholder: f.placeholder || ""
        }));
      });
    }

    function buildResearch(){
      researchColLeft.innerHTML = "";
      researchColRight.innerHTML = "";
      const byTitle = itemColsByTitle;

      RESEARCH_LEFT.forEach(f=>{
        const cv = findByTitle(byTitle, TITLES[f.key]);
        researchColLeft.appendChild(makeRow({
          label: f.label,
          valueText: cv?.text || "",
          kind: "text",
          columnId: cv?.id || null,
          valueType: cv?.type || "text",
          placeholder: f.placeholder || ""
        }));
      });

      RESEARCH_RIGHT.forEach(f=>{
        const cv = findByTitle(byTitle, TITLES[f.key]);
        researchColRight.appendChild(makeRow({
          label: f.label,
          valueText: cv?.text || "",
          kind: f.kind || (cv?.type === "date" ? "date" : "text"),
          columnId: cv?.id || null,
          valueType: cv?.type || (f.kind === "date" ? "date" : "text"),
          placeholder: f.placeholder || ""
        }));
      });
    }

    function buildActions(){
      actionPanelEl.innerHTML = "";
      const byTitle = itemColsByTitle;

      ACTIONS.forEach(f=>{
        const cv = findByTitle(byTitle, TITLES[f.key]);
        actionPanelEl.appendChild(makeRow({
          label: f.label,
          valueText: cv?.text || "",
          kind: f.kind || (cv?.type === "date" ? "date" : "text"),
          columnId: cv?.id || null,
          valueType: cv?.type || (f.kind === "date" ? "date" : "text"),
          placeholder: f.placeholder || ""
        }));
      });
    }

    function buildSubitems(){
      subitemsBodyEl.innerHTML = "";
      const subs = record?.subitems || [];

      if(!subs.length){
        // ✅ Always show at least one empty row (layout stays consistent)
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="nameCell">—</td>
          <td><input class="input" style="height:30px;" placeholder="Offer Made"></td>
          <td><input class="input" style="height:30px;" placeholder="Relationship"></td>
          <td><input class="input" style="height:30px;" placeholder="Lead Status"></td>
          <td><input class="input" style="height:30px;" placeholder="Phone 1"></td>
          <td><input class="input" style="height:30px;" placeholder="Status"></td>
          <td><input class="input" style="height:30px;" placeholder="Phone 2"></td>
          <td><input class="input" style="height:30px;" placeholder="Status"></td>
          <td><input class="input" style="height:30px;" placeholder="Phone 3"></td>
          <td><input class="input" style="height:30px;" placeholder="Status"></td>
        `;
        subitemsBodyEl.appendChild(tr);
        return;
      }

      // (If subitems exist later, you can map and render them here)
      subs.forEach(sub=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="nameCell" title="${String(sub.name||"")}">${String(sub.name||"—")}</td>
          <td class="muted">—</td>
          <td class="muted">—</td>
          <td class="muted">—</td>
          <td class="muted">—</td>
          <td class="muted">—</td>
          <td class="muted">—</td>
          <td class="muted">—</td>
          <td class="muted">—</td>
          <td class="muted">—</td>
        `;
        subitemsBodyEl.appendChild(tr);
      });
    }

    function setTab(which){
      const deal = (which === "deal");
      tabDeal.setAttribute("aria-selected", String(deal));
      tabResearch.setAttribute("aria-selected", String(!deal));
      panelDeal.hidden = !deal;
      panelResearch.hidden = deal;
    }
    tabDeal.addEventListener("click", ()=>setTab("deal"));
    tabResearch.addEventListener("click", ()=>setTab("research"));

    function renderAll(){
      recordNameEl.textContent = record?.name || "—";
      itemColsByTitle = indexColumns(record?.column_values || []);
      buildMetrics();
      buildDealInfo();
      buildResearch();
      buildActions();
      buildSubitems();
    }

    // ✅ NEW: Always initialize a blank record so fields render instantly.
    function initBlankRecord(){
      const itemId = getParam("itemId") || "—";
      record = {
        id: String(itemId),
        name: (itemId && itemId !== "—") ? `Item ${itemId}` : "—",
        column_values: [],
        subitems: []
      };
      dirty.item.clear();
      dirty.subitems.clear();
      renderAll();
    }

    async function loadRecord(){
      const itemId = getParam("itemId");

      // Even if missing itemId, we still render all fields (blank)
      if(!itemId){
        initBlankRecord();
        showToast("Tip: Add ?itemId=### to the URL to tie this page to a Monday item.");
        return;
      }

      // If no webhook configured yet, still render fields (blank) immediately
      if(!MAKE_GET_RECORD_URL){
        initBlankRecord();
        return;
      }

      // If webhook is configured later, it will load and fill values
      try{
        const url = new URL(MAKE_GET_RECORD_URL);
        url.searchParams.set("itemId", itemId);

        const res = await fetch(url.toString(), {
          method: "GET",
          headers: { "Accept": "application/json" },
          cache: "no-store"
        });
        if(!res.ok) throw new Error("GET failed: " + res.status);

        const data = await res.json();
        const item = data?.item || data?.items?.[0] || data?.data?.items?.[0];
        if(!item) throw new Error("No item in response");

        record = {
          id: String(item.id),
          name: item.name || `Item ${itemId}`,
          column_values: item.column_values || [],
          subitems: item.subitems || []
        };

        dirty.item.clear();
        dirty.subitems.clear();
        renderAll();
      } catch (e){
        console.warn(e);
        initBlankRecord();
        showToast("Could not load item yet (no webhook / bad response). Showing empty fields.");
      }
    }

    // Save buttons (will no-op until you set SET webhook + columns are known)
    function webhookMissing(){
      return !MAKE_SET_FIELD_URL;
    }

    saveAllBtn.addEventListener("click", ()=>{
      if(webhookMissing()){
        showToast("Saving disabled until you set up Make webhooks.");
        return;
      }
      showToast("Saving will be enabled once Make is connected.");
    });

    saveDealBtn.addEventListener("click", ()=>{
      if(webhookMissing()){
        showToast("Saving disabled until you set up Make webhooks.");
        return;
      }
      showToast("Saving will be enabled once Make is connected.");
    });

    saveResearchBtn.addEventListener("click", ()=>{
      if(webhookMissing()){
        showToast("Saving disabled until you set up Make webhooks.");
        return;
      }
      showToast("Saving will be enabled once Make is connected.");
    });

    saveActionsBtn.addEventListener("click", ()=>{
      if(webhookMissing()){
        showToast("Saving disabled until you set up Make webhooks.");
        return;
      }
      showToast("Saving will be enabled once Make is connected.");
    });

    saveSubitemsBtn.addEventListener("click", ()=>{
      if(webhookMissing()){
        showToast("Saving disabled until you set up Make webhooks.");
        return;
      }
      showToast("Saving will be enabled once Make is connected.");
    });

    refreshBtn.addEventListener("click", loadRecord);

    // Init
    setTab("deal");
    initBlankRecord();  // ✅ render immediately with empty fields
    loadRecord();       // ✅ attempt to fill if GET webhook exists (otherwise stays blank)
  </script>
</body>
</html>
