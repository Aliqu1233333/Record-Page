<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Record Page</title>
  <style>
    :root{
      /* Cleaner, more native SF-ish stack (less rigid) */
      --font: "Salesforce Sans", ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";

      --bg: transparent;
      --card: #ffffff;
      --border: #e6e6e6;
      --muted: #6b7280;
      --text: #111827;

      --blue: #17345b;
      --blue-2: #1d63ff;

      --radius: 12px;

      --padY: 12px;
      --padX: 10px;

      --gap: 12px;

      --field-h: 34px;
      --field-radius: 8px;
      --field-bg: #ffffff;
      --field-border: #d1d5db;

      --toast-bg: #bff3ea;
      --toast-fg: #0d3a33;
      --toast-shadow: 0 10px 30px rgba(0,0,0,0.10);
      --toast-radius: 10px;
    }

    html,body{
      width:100%;
      max-width:100%;
      overflow-x:hidden;
      background: var(--bg);
      font-family: var(--font);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin:0;
      padding:0;
    }

    body{
      padding: var(--padY) var(--padX);
      box-sizing:border-box;
      min-height: 180px;
    }

    .page{
      width:100%;
      max-width: 100%;
      min-width: 0;
      display:flex;
      flex-direction: column;
      gap: var(--gap);
    }

    /* ----- Minimal, clean containers (less “bubbly”) ----- */
    .section{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
    }

    .sectionHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      min-width:0;
    }

    /* Header */
    .headerLeft{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }

    .iconBadge{
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: rgba(29,99,255,0.10);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }

    .recordTitle{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .recordType{
      font-size: 11px;
      font-weight: 650;
      color: var(--muted);
      line-height: 1.2;
    }
    .recordName{
      font-size: 14px;
      font-weight: 750;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }

    .headerActions{
      display:flex;
      align-items:center;
      gap: 8px;
      flex: 0 0 auto;
    }

    .btn{
      height: 32px;
      padding: 0 10px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: #fff;
      color: #111;
      font-size: 12px;
      font-weight: 650;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap: 8px;
      transition: transform 120ms ease, filter 120ms ease;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }

    .btnPrimary{
      border: 0;
      background: var(--blue-2);
      color: #fff;
      font-weight: 700;
    }
    .btnPrimary:hover{ filter: brightness(1.03); }

    /* Highlights row (remove “bubble cards”; keep clean) */
    .highlights{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0;
      padding: 10px 12px;
    }

    .metric{
      padding: 8px 10px;
      min-width:0;
    }
    .metric + .metric{
      border-left: 1px solid var(--border);
    }
    .metricLabel{
      font-size: 11px;
      font-weight: 650;
      color: var(--muted);
    }
    .metricValue{
      margin-top: 6px;
      font-size: 18px;
      font-weight: 750;
      letter-spacing: .1px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    /* Main grid */
    .grid{
      display:grid;
      grid-template-columns: minmax(0, 2fr) minmax(280px, 1fr);
      gap: var(--gap);
      align-items:start;
      min-width:0;
    }

    /* Tabs: NOT bubbles. Clickable categories with underline like SF */
    .tabsBar{
      display:flex;
      align-items:center;
      gap: 18px;
      padding: 10px 12px 0 12px;
      background: #fff;
    }
    .tabLink{
      appearance:none;
      border:0;
      background: transparent;
      padding: 8px 0;
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      cursor:pointer;
      position: relative;
    }
    .tabLink[aria-selected="true"]{
      color: var(--text);
    }
    .tabLink[aria-selected="true"]::after{
      content:"";
      position:absolute;
      left:0;
      right:0;
      bottom:-1px;
      height:2px;
      background: var(--blue-2);
      border-radius: 2px;
    }
    .tabsDivider{
      border-bottom: 1px solid var(--border);
      margin: 0 12px;
    }

    .tabPanel{
      padding: 12px;
      min-width:0;
    }
    .tabPanel[hidden]{ display:none; }

    /* “Details-style” fields (fixed placement, never disappear) */
    .detailsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 0 24px;
      min-width:0;
    }

    .detailsCol{
      display:flex;
      flex-direction:column;
      gap: 0;
      min-width:0;
    }

    .row{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 12px;
      align-items:center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,0.04); /* very subtle */
      min-width:0;
    }
    .row:last-child{ border-bottom: 0; }

    .rowLabel{
      font-size: 11px;
      font-weight: 650;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .input{
      width: 100%;
      height: var(--field-h);
      border-radius: var(--field-radius);
      border: 1px solid var(--field-border);
      background: var(--field-bg);
      padding: 0 10px;
      box-sizing:border-box;
      font-size: 12px;
      font-weight: 600;
      color: #111;
      outline: none;
      transition: box-shadow 140ms ease, border-color 140ms ease;
      min-width:0;
    }
    .input:focus{
      border-color: rgba(29,99,255,0.55);
      box-shadow: 0 0 0 3px rgba(29,99,255,0.10);
    }

    .rowActions{
      display:flex;
      gap: 8px;
      justify-content:flex-end;
      margin-top: 12px;
    }

    .btnSmall{
      height: 30px;
      padding: 0 10px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 700;
    }

    /* Right panel body */
    .panelBody{
      padding: 12px;
      min-width:0;
    }

    /* Related table (keep clean) */
    .tableWrap{
      width:100%;
      overflow:auto;
    }
    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 760px;
    }
    thead th{
      background: #fafafa;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      font-weight: 700;
      color: #374151;
      text-align:left;
      padding: 10px 10px;
      position: sticky;
      top: 0;
      z-index: 1;
      white-space: nowrap;
    }
    tbody td{
      border-bottom: 1px solid rgba(0,0,0,0.06);
      padding: 10px 10px;
      font-size: 12px;
      font-weight: 600;
      color: #111827;
      vertical-align: middle;
      white-space: nowrap;
    }

    .nameCell{
      font-weight: 700;
      max-width: 240px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .muted{
      color: var(--muted);
      font-weight: 600;
    }

    .skeleton{
      background: linear-gradient(90deg, #f2f3f5 25%, #eceef2 37%, #f2f3f5 63%);
      background-size: 400% 100%;
      animation: shimmer 1.2s ease infinite;
      border-radius: 8px;
    }
    @keyframes shimmer{
      0%{ background-position: 100% 0; }
      100%{ background-position: 0 0; }
    }

    /* Toast */
    .toast{
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%) translateY(-10px);
      opacity: 0;
      pointer-events:none;
      background: var(--toast-bg);
      color: var(--toast-fg);
      border-radius: var(--toast-radius);
      box-shadow: var(--toast-shadow);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 320px;
      max-width: min(520px, calc(100vw - 24px));
      z-index: 99999;
      transition: opacity 200ms ease, transform 200ms ease;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(0px);
      pointer-events:auto;
    }
    .toast .msg{
      font-weight: 700;
      font-size: 13px;
      flex:1;
    }
    .toast .x{
      border:0;
      background: transparent;
      cursor:pointer;
      width: 26px;
      height: 26px;
      display:grid;
      place-items:center;
      border-radius: 7px;
      transition: background 120ms ease;
    }
    .toast .x:hover{ background: rgba(0,0,0,0.06); }

    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
      table{ min-width: 720px; }
      .highlights{ grid-template-columns: 1fr; }
      .metric + .metric{ border-left: 0; border-top: 1px solid var(--border); }
      .detailsGrid{ grid-template-columns: 1fr; }
      .row{ grid-template-columns: 140px 1fr; }
    }
  </style>
</head>

<body>
  <div class="page" id="app">

    <!-- Header -->
    <div class="section">
      <div class="sectionHeader">
        <div class="headerLeft">
          <div class="iconBadge" aria-hidden="true">
            <svg width="16" height="16" viewBox="0 0 24 24">
              <path fill="#1d63ff" d="M12 12c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4Zm0 2c-2.7 0-8 1.4-8 4v2h16v-2c0-2.6-5.3-4-8-4Z"/>
            </svg>
          </div>
          <div class="recordTitle">
            <div class="recordType">Lead</div>
            <div class="recordName" id="recordName">Loading…</div>
          </div>
        </div>

        <div class="headerActions">
          <button class="btn" id="refreshBtn" type="button" title="Refresh data">
            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="#111827" d="M17.65 6.35A7.95 7.95 0 0 0 12 4V1L7 6l5 5V7a6 6 0 1 1-6 6H4a8 8 0 1 0 13.65-6.65Z"/>
            </svg>
            Refresh
          </button>
          <button class="btn btnPrimary" id="saveAllBtn" type="button" title="Save all changes">
            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="#fff" d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4Zm0 16H7v-6h10v6Zm-3-10H6V5h8v4Z"/>
            </svg>
            Save Changes
          </button>
        </div>
      </div>

      <div class="highlights">
        <div class="metric">
          <div class="metricLabel">Lead Score</div>
          <div class="metricValue" id="metricLeadScore">
            <span class="skeleton" style="display:inline-block;width:70px;height:18px;"></span>
          </div>
        </div>
        <div class="metric">
          <div class="metricLabel">Age in Stage</div>
          <div class="metricValue" id="metricAgeInStage">
            <span class="skeleton" style="display:inline-block;width:90px;height:18px;"></span>
          </div>
        </div>
        <div class="metric">
          <div class="metricLabel">Days Since Last Activity</div>
          <div class="metricValue" id="metricDaysSince">
            <span class="skeleton" style="display:inline-block;width:90px;height:18px;"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Main -->
    <div class="grid">

      <!-- Left: tabs + details layout -->
      <div class="section">
        <div class="tabsBar" role="tablist" aria-label="Record tabs">
          <button class="tabLink" id="tabDeal" role="tab" aria-selected="true" aria-controls="panelDeal" type="button">Deal Information</button>
          <button class="tabLink" id="tabResearch" role="tab" aria-selected="false" aria-controls="panelResearch" type="button">Deep Research</button>
        </div>
        <div class="tabsDivider"></div>

        <div class="tabPanel" id="panelDeal" role="tabpanel" aria-labelledby="tabDeal">
          <div class="detailsGrid">
            <div class="detailsCol" id="dealColLeft"></div>
            <div class="detailsCol" id="dealColRight"></div>
          </div>
          <div class="rowActions">
            <button class="btn btnSmall" id="saveDealBtn" type="button">Save Deal Info</button>
          </div>
        </div>

        <div class="tabPanel" id="panelResearch" role="tabpanel" aria-labelledby="tabResearch" hidden>
          <div class="detailsGrid">
            <div class="detailsCol" id="researchColLeft"></div>
            <div class="detailsCol" id="researchColRight"></div>
          </div>
          <div class="rowActions">
            <button class="btn btnSmall" id="saveResearchBtn" type="button">Save Deep Research</button>
          </div>
        </div>
      </div>

      <!-- Right: Action panel -->
      <div class="section">
        <div class="sectionHeader">
          <div style="min-width:0;">
            <div style="font-size:12px;font-weight:750;">Next Actions</div>
            <div style="font-size:11px;font-weight:600;color:var(--muted);">Follow-up + next step</div>
          </div>
        </div>
        <div class="panelBody" id="actionPanel"></div>
        <div class="rowActions" style="padding: 0 12px 12px;">
          <button class="btn btnSmall btnPrimary" id="saveActionsBtn" type="button">Save Actions</button>
        </div>
      </div>

    </div>

    <!-- Related records -->
    <div class="section">
      <div class="sectionHeader">
        <div style="min-width:0;">
          <div style="font-size:12px;font-weight:750;">Related Records</div>
          <div style="font-size:11px;font-weight:600;color:var(--muted);">Owners / Subitems</div>
        </div>
        <button class="btn" id="saveSubitemsBtn" type="button">Save Subitems</button>
      </div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Offer Made</th>
              <th>Relationship</th>
              <th>Lead Status</th>
              <th>Phone 1</th>
              <th>Phone 1 Status</th>
              <th>Phone 2</th>
              <th>Phone 2 Status</th>
              <th>Phone 3</th>
              <th>Phone 3 Status</th>
            </tr>
          </thead>
          <tbody id="subitemsBody">
            <tr>
              <td colspan="10" class="muted" style="padding:14px 10px;">Loading…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite">
    <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
      <path fill="#0ba79c" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm-1 14-4-4 1.4-1.4L11 12.2l5.6-5.6L18 8l-7 8Z"/>
    </svg>
    <div class="msg" id="toastMsg">Saved.</div>
    <button class="x" id="toastClose" type="button" aria-label="Dismiss">
      <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#0d3a33" d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3z"/>
      </svg>
    </button>
  </div>

  <script>
    // ✅ Paste your Make webhook endpoints (FULL URLs)
    const MAKE_GET_RECORD_URL = "https://hook.us1.make.com/"; // <-- FULL get-record webhook url
    const MAKE_SET_FIELD_URL  = "https://hook.us1.make.com/"; // <-- FULL set-field webhook url

    // Titles to match from your board
    const TITLES = {
      leadScore: "Lead Score",
      ageInStage: "Age In Stage",
      lastActivityDate: "Last Activity Date", // add this column in Monday for the metric

      address: "Address",
      city: "City",
      leadType: "Lead Type",
      taxes: "Taxes",
      condition: "Condition",
      occupancy: "Occupancy",
      titleIssue: "Title issue",
      willStatus: "Will Status",
      deedStatus: "Deed Status",

      taxAssessor: "Tax Assesor",
      zillow: "Zillow",
      obituary: "Obituary",
      ancestry: "Ancestry",
      age: "Age",
      birthDate: "Birth Date",
      deathDate: "Death Date",

      followUpDate: "Follow Up Date",
      nextActionStep: "Next Action Step",
      stalledReason: "Stalled Reason"
    };

    const SUB_TITLES = {
      offerMade: "Offer Made",
      relationship: "Relation Ship",
      leadStatus: "Lead Status",
      phone1: "Phone 1",
      phone1Status: "Phone 1 status",
      phone2: "Phone 2",
      phone2Status: "Phone 2 status",
      phone3: "Phone 3",
      phone3Status: "Phone 3 status"
    };

    // --- DOM
    const recordNameEl = document.getElementById("recordName");
    const metricLeadScoreEl = document.getElementById("metricLeadScore");
    const metricAgeInStageEl = document.getElementById("metricAgeInStage");
    const metricDaysSinceEl = document.getElementById("metricDaysSince");

    const dealColLeft = document.getElementById("dealColLeft");
    const dealColRight = document.getElementById("dealColRight");
    const researchColLeft = document.getElementById("researchColLeft");
    const researchColRight = document.getElementById("researchColRight");

    const actionPanelEl = document.getElementById("actionPanel");
    const subitemsBodyEl = document.getElementById("subitemsBody");

    const refreshBtn = document.getElementById("refreshBtn");
    const saveAllBtn = document.getElementById("saveAllBtn");
    const saveDealBtn = document.getElementById("saveDealBtn");
    const saveResearchBtn = document.getElementById("saveResearchBtn");
    const saveActionsBtn = document.getElementById("saveActionsBtn");
    const saveSubitemsBtn = document.getElementById("saveSubitemsBtn");

    // Tabs
    const tabDeal = document.getElementById("tabDeal");
    const tabResearch = document.getElementById("tabResearch");
    const panelDeal = document.getElementById("panelDeal");
    const panelResearch = document.getElementById("panelResearch");

    // Toast
    const toast = document.getElementById("toast");
    const toastMsg = document.getElementById("toastMsg");
    const toastClose = document.getElementById("toastClose");
    let toastTimer = null;

    function showToast(msg){
      toastMsg.textContent = msg || "Saved.";
      toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toast.classList.remove("show"), 2400);
    }
    toastClose.addEventListener("click", ()=>toast.classList.remove("show"));

    function getParam(name){
      return new URLSearchParams(window.location.search).get(name);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // --- State
    let record = null;
    let itemColsByTitle = new Map();
    let subColsById = new Map();

    const dirty = {
      item: new Map(),        // columnId -> payload
      subitems: new Map()     // `${subitemId}:${columnId}` -> payload
    };

    function normalize(s){ return String(s || "").trim().toLowerCase(); }

    function indexColumns(columnValues){
      const byTitle = new Map();
      (columnValues || []).forEach(cv => byTitle.set(normalize(cv.title), cv));
      return byTitle;
    }

    function findByTitle(byTitleMap, title){
      if(!title) return null;
      const exact = byTitleMap.get(normalize(title));
      if(exact) return exact;
      const t = normalize(title);
      for(const [k,v] of byTitleMap.entries()){
        if(k.includes(t) || t.includes(k)) return v;
      }
      return null;
    }

    function parseDateFromText(text){
      const s = String(text || "").trim();
      if(!s) return null;
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }

    function toISODate(text){
      const d = parseDateFromText(text);
      if(!d) return "";
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function daysBetween(d1, d2){
      const a = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate()).getTime();
      const b = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate()).getTime();
      return Math.floor((b - a) / (1000*60*60*24));
    }

    function makeRow({label, valueText, kind="text", columnId=null, valueType="text"}){
      // IMPORTANT: Always render rows in fixed placement even if empty / missing column
      const row = document.createElement("div");
      row.className = "row";

      const l = document.createElement("div");
      l.className = "rowLabel";
      l.textContent = label;

      const input = document.createElement("input");
      input.className = "input";
      input.type = (kind === "date") ? "date" : "text";
      input.value = (kind === "date") ? toISODate(valueText) : (valueText || "");

      input.addEventListener("change", ()=>{
        if(!columnId) return; // if the column truly doesn't exist in Monday yet, can't save
        const v = input.value;
        dirty.item.set(columnId, {
          target:"item",
          itemId: record?.id,
          columnId,
          valueText: v,
          valueType: valueType || (kind === "date" ? "date" : "text")
        });
      });

      row.appendChild(l);
      row.appendChild(input);
      return row;
    }

    function buildMetrics(){
      const byTitle = itemColsByTitle;

      metricLeadScoreEl.textContent = findByTitle(byTitle, TITLES.leadScore)?.text || "—";
      metricAgeInStageEl.textContent = findByTitle(byTitle, TITLES.ageInStage)?.text || "—";

      const lastAct = findByTitle(byTitle, TITLES.lastActivityDate);
      const d = parseDateFromText(lastAct?.text || "");
      metricDaysSinceEl.textContent = d ? `${Math.max(0, daysBetween(d, new Date()))} days` : "—";
    }

    function buildDealInfo(){
      dealColLeft.innerHTML = "";
      dealColRight.innerHTML = "";

      const byTitle = itemColsByTitle;

      const left = [
        { key:"address", label:"Address" },
        { key:"city", label:"City" },
        { key:"leadType", label:"Lead Type" },
        { key:"taxes", label:"Taxes" }
      ];
      const right = [
        { key:"condition", label:"Condition" },
        { key:"occupancy", label:"Occupancy" },
        { key:"titleIssue", label:"Title issue" },
        { key:"willStatus", label:"Will Status" },
        { key:"deedStatus", label:"Deed Status" }
      ];

      left.forEach(f=>{
        const cv = findByTitle(byTitle, TITLES[f.key]);
        dealColLeft.appendChild(makeRow({
          label: f.label,
          valueText: cv?.text || "",
          kind: (cv?.type === "date") ? "date" : "text",
          columnId: cv?.id || null,
          valueType: cv?.type || "text"
        }));
      });

      right.forEach(f=>{
        const cv = findByTitle(byTitle, TITLES[f.key]);
        dealColRight.appendChild(makeRow({
          label: f.label,
          valueText: cv?.text || "",
          kind: (cv?.type === "date") ? "date" : "text",
          columnId: cv?.id || null,
          valueType: cv?.type || "text"
        }));
      });
    }

    function buildResearch(){
      researchColLeft.innerHTML = "";
      researchColRight.innerHTML = "";

      const byTitle = itemColsByTitle;

      const left = [
        { key:"taxAssessor", label:"Tax Assessor Link" },
        { key:"zillow", label:"Zillow" },
        { key:"obituary", label:"Obituary" },
        { key:"ancestry", label:"Ancestry" }
      ];
      const right = [
        { key:"age", label:"Age" },
        { key:"birthDate", label:"Birth Date", kind:"date" },
        { key:"deathDate", label:"Death Date", kind:"date" }
      ];

      left.forEach(f=>{
        const cv = findByTitle(byTitle, TITLES[f.key]);
        researchColLeft.appendChild(makeRow({
          label: f.label,
          valueText: cv?.text || "",
          kind: "text",
          columnId: cv?.id || null,
          valueType: cv?.type || "text"
        }));
      });

      right.forEach(f=>{
        const cv = findByTitle(byTitle, TITLES[f.key]);
        researchColRight.appendChild(makeRow({
          label: f.label,
          valueText: cv?.text || "",
          kind: f.kind || ((cv?.type === "date") ? "date" : "text"),
          columnId: cv?.id || null,
          valueType: cv?.type || (f.kind === "date" ? "date" : "text")
        }));
      });
    }

    function buildActions(){
      actionPanelEl.innerHTML = "";

      const byTitle = itemColsByTitle;

      const followUp = findByTitle(byTitle, TITLES.followUpDate);
      const nextStep = findByTitle(byTitle, TITLES.nextActionStep);
      const stalled = findByTitle(byTitle, TITLES.stalledReason);

      actionPanelEl.appendChild(makeRow({
        label: "Follow Up Date",
        valueText: followUp?.text || "",
        kind: "date",
        columnId: followUp?.id || null,
        valueType: followUp?.type || "date"
      }));

      actionPanelEl.appendChild(makeRow({
        label: "Next Action Step",
        valueText: nextStep?.text || "",
        kind: "text",
        columnId: nextStep?.id || null,
        valueType: nextStep?.type || "text"
      }));

      actionPanelEl.appendChild(makeRow({
        label: "Stalled Reason",
        valueText: stalled?.text || "",
        kind: "text",
        columnId: stalled?.id || null,
        valueType: stalled?.type || "text"
      }));
    }

    function makeSubCellInput({subitemId, columnMeta}){
      const input = document.createElement("input");
      input.className = "input";
      input.style.height = "30px";
      input.style.borderRadius = "8px";
      input.style.fontSize = "12px";
      input.style.fontWeight = "600";
      input.type = "text";
      input.value = columnMeta?.text || "";

      input.addEventListener("change", ()=>{
        if(!columnMeta?.id) return;
        const key = `${subitemId}:${columnMeta.id}`;
        dirty.subitems.set(key, {
          target: "subitem",
          itemId: record?.id,
          subitemId,
          columnId: columnMeta.id,
          valueText: input.value,
          valueType: columnMeta.type || "text"
        });
      });

      return input;
    }

    function buildSubitems(){
      subitemsBodyEl.innerHTML = "";
      const subs = record?.subitems || [];

      if(!subs.length){
        subitemsBodyEl.innerHTML = `<tr><td colspan="10" class="muted" style="padding:14px 10px;">No related records (subitems).</td></tr>`;
        return;
      }

      subs.forEach(sub=>{
        const byTitle = indexColumns(sub.column_values || []);
        subColsById.set(String(sub.id), byTitle);

        const offerMade = findByTitle(byTitle, SUB_TITLES.offerMade);
        const relationship = findByTitle(byTitle, SUB_TITLES.relationship);
        const leadStatus = findByTitle(byTitle, SUB_TITLES.leadStatus);

        const phone1 = findByTitle(byTitle, SUB_TITLES.phone1);
        const phone1Status = findByTitle(byTitle, SUB_TITLES.phone1Status);

        const phone2 = findByTitle(byTitle, SUB_TITLES.phone2);
        const phone2Status = findByTitle(byTitle, SUB_TITLES.phone2Status);

        const phone3 = findByTitle(byTitle, SUB_TITLES.phone3);
        const phone3Status = findByTitle(byTitle, SUB_TITLES.phone3Status);

        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.className = "nameCell";
        tdName.title = sub.name || "";
        tdName.textContent = sub.name || "—";
        tr.appendChild(tdName);

        const tdOffer = document.createElement("td"); tdOffer.appendChild(makeSubCellInput({ subitemId:String(sub.id), columnMeta: offerMade })); tr.appendChild(tdOffer);
        const tdRel   = document.createElement("td"); tdRel.appendChild(makeSubCellInput({ subitemId:String(sub.id), columnMeta: relationship })); tr.appendChild(tdRel);
        const tdLead  = document.createElement("td"); tdLead.appendChild(makeSubCellInput({ subitemId:String(sub.id), columnMeta: leadStatus })); tr.appendChild(tdLead);

        const tdP1    = document.createElement("td"); tdP1.appendChild(makeSubCellInput({ subitemId:String(sub.id), columnMeta: phone1 })); tr.appendChild(tdP1);
        const tdP1s   = document.createElement("td"); tdP1s.appendChild(makeSubCellInput({ subitemId:String(sub.id), columnMeta: phone1Status })); tr.appendChild(tdP1s);

        const tdP2    = document.createElement("td"); tdP2.appendChild(makeSubCellInput({ subitemId:String(sub.id), columnMeta: phone2 })); tr.appendChild(tdP2);
        const tdP2s   = document.createElement("td"); tdP2s.appendChild(makeSubCellInput({ subitemId:String(sub.id), columnMeta: phone2Status })); tr.appendChild(tdP2s);

        const tdP3    = document.createElement("td"); tdP3.appendChild(makeSubCellInput({ subitemId:String(sub.id), columnMeta: phone3 })); tr.appendChild(tdP3);
        const tdP3s   = document.createElement("td"); tdP3s.appendChild(makeSubCellInput({ subitemId:String(sub.id), columnMeta: phone3Status })); tr.appendChild(tdP3s);

        subitemsBodyEl.appendChild(tr);
      });
    }

    function setTab(which){
      const deal = (which === "deal");
      tabDeal.setAttribute("aria-selected", String(deal));
      tabResearch.setAttribute("aria-selected", String(!deal));
      panelDeal.hidden = !deal;
      panelResearch.hidden = deal;
    }
    tabDeal.addEventListener("click", ()=>setTab("deal"));
    tabResearch.addEventListener("click", ()=>setTab("research"));

    function setLoadingState(){
      recordNameEl.textContent = "Loading…";
      metricLeadScoreEl.innerHTML = `<span class="skeleton" style="display:inline-block;width:70px;height:18px;"></span>`;
      metricAgeInStageEl.innerHTML = `<span class="skeleton" style="display:inline-block;width:90px;height:18px;"></span>`;
      metricDaysSinceEl.innerHTML = `<span class="skeleton" style="display:inline-block;width:90px;height:18px;"></span>`;
      subitemsBodyEl.innerHTML = `<tr><td colspan="10" class="muted" style="padding:14px 10px;">Loading…</td></tr>`;
    }

    function renderAll(){
      recordNameEl.textContent = record?.name || "—";
      itemColsByTitle = indexColumns(record?.column_values || []);
      buildMetrics();
      buildDealInfo();
      buildResearch();
      buildActions();
      buildSubitems();
    }

    async function loadRecord(){
      const itemId = getParam("itemId");
      if(!itemId){
        showToast("Missing itemId in URL. Add ?itemId=###");
        return;
      }
      if(!MAKE_GET_RECORD_URL || MAKE_GET_RECORD_URL === "https://hook.us1.make.com/"){
        showToast("GET webhook not configured.");
        return;
      }

      setLoadingState();

      try{
        const url = new URL(MAKE_GET_RECORD_URL);
        url.searchParams.set("itemId", itemId);

        const res = await fetch(url.toString(), {
          method: "GET",
          headers: { "Accept": "application/json" },
          cache: "no-store"
        });
        if(!res.ok) throw new Error("GET failed: " + res.status);

        const data = await res.json();
        const item = data?.item || data?.items?.[0] || data?.data?.items?.[0];
        if(!item) throw new Error("No item in response");

        record = {
          id: String(item.id),
          name: item.name || "",
          column_values: item.column_values || [],
          subitems: item.subitems || []
        };

        dirty.item.clear();
        dirty.subitems.clear();

        renderAll();
      } catch (e){
        console.warn(e);
        showToast("Could not load record.");
      }
    }

    async function postSetField(payload){
      if(!MAKE_SET_FIELD_URL || MAKE_SET_FIELD_URL === "https://hook.us1.make.com/"){
        showToast("SET webhook not configured.");
        throw new Error("SET webhook not configured");
      }
      const res = await fetch(MAKE_SET_FIELD_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        keepalive: true
      });
      if(!res.ok) throw new Error("SET failed: " + res.status);
    }

    async function savePayloads(payloads){
      if(!payloads.length){
        showToast("No changes to save.");
        return;
      }
      try{
        for(const p of payloads) await postSetField(p);
        showToast("Saved successfully.");
        await loadRecord();
      } catch (e){
        console.warn(e);
        showToast("Save failed. Please retry.");
      }
    }

    function collectItemPayloads(onlyColumnIds=null){
      const out = [];
      for(const [columnId, payload] of dirty.item.entries()){
        if(onlyColumnIds && !onlyColumnIds.includes(columnId)) continue;
        out.push(payload);
      }
      return out;
    }
    function collectSubitemPayloads(){
      return Array.from(dirty.subitems.values());
    }

    // Save buttons
    saveAllBtn.addEventListener("click", async ()=>{
      await savePayloads([...collectItemPayloads(), ...collectSubitemPayloads()]);
    });

    saveDealBtn.addEventListener("click", async ()=>{
      const ids = [];
      const byTitle = itemColsByTitle;
      [TITLES.address, TITLES.city, TITLES.leadType, TITLES.taxes, TITLES.condition, TITLES.occupancy, TITLES.titleIssue, TITLES.willStatus, TITLES.deedStatus]
        .forEach(t => { const cv = findByTitle(byTitle, t); if(cv?.id) ids.push(cv.id); });
      await savePayloads(collectItemPayloads(ids));
    });

    saveResearchBtn.addEventListener("click", async ()=>{
      const ids = [];
      const byTitle = itemColsByTitle;
      [TITLES.taxAssessor, TITLES.zillow, TITLES.obituary, TITLES.ancestry, TITLES.age, TITLES.birthDate, TITLES.deathDate]
        .forEach(t => { const cv = findByTitle(byTitle, t); if(cv?.id) ids.push(cv.id); });
      await savePayloads(collectItemPayloads(ids));
    });

    saveActionsBtn.addEventListener("click", async ()=>{
      const ids = [];
      const byTitle = itemColsByTitle;
      [TITLES.followUpDate, TITLES.nextActionStep, TITLES.stalledReason]
        .forEach(t => { const cv = findByTitle(byTitle, t); if(cv?.id) ids.push(cv.id); });
      await savePayloads(collectItemPayloads(ids));
    });

    saveSubitemsBtn.addEventListener("click", async ()=>{
      await savePayloads(collectSubitemPayloads());
    });

    refreshBtn.addEventListener("click", loadRecord);

    // Init
    setTab("deal");
    loadRecord();
  </script>
</body>
</html>
